# 视频下载传输有问题，目前只能通过OSS存储桶链接进行下载（手动部署可能可以成功下载，docker用户不一定，不是非常影响使用）
# AstrBot SiliconFlow 视频生成插件

本插件允许您的 AstrBot 接入 [SiliconFlow](https://siliconflow.cn/) API，提供强大的 **文生视频** 和 **图生视频** 功能。

它内置了完善的 API Key 轮询、用户/群组次数限制、黑白名单权限控制和代理支持，非常适合在聊天群中部署和管理。

## ✨ 功能特性

- **核心功能**:
  - **文生视频**: 根据文本提示词生成视频。
  - **图生视频**: 结合图片和文本提示词生成动态视频。
- **管理与限制**:
  - 支持配置多个 API Key，并自动轮询使用，避免单个 Key 额度耗尽。
  - 完善的**用户次数**和**群组共享次数**限制系统。
  - 管理员可随时为用户或群组增加次数。
- **权限控制**:
  - 支持用户黑名单、用户白名单、群组白名单，实现精细化权限管理。
- **网络支持**:
  - 支持通过 HTTP/HTTPS 网络代理访问 API。

## 📦 安装说明

1.  **下载插件文件**:
    确保您拥有 `main.py` 和 `_conf_schema.json` 这两个文件。

2.  **放置文件**:
    在您的 AstrBot 根目录下，找到 `data/plugins` 文件夹。在其中创建一个新的文件夹，例如 `astrbot_plugin_siliconflow`。
    将 `main.py` 和 `_conf_schema.json` 这两个文件放入刚刚创建的文件夹中。
    最终的目录结构应如下所示：
    ```
    AstrBot/
    └── data/
        └── plugins/
            └── astrbot_plugin_siliconflow/
                ├── main.py
                └── _conf_schema.json
    ```
3.  **配置 AstrBot（不配置可能用不了）**:
   打开配置文件里面的系统配置，找到“对外可达的回调接口地址”，填入：如果是docker用户，重启点开控制台，查看你的ip（就是你nc填入的ip）比如ws:172.16.x.x:6199/ws的，直接改成http:172.16.x.x:6185,如果手动部署和host可以填入http://127.0.0.1:6185.
4.  **重启 AstrBot**:
    完全关闭并重新启动您的 AstrBot 程序，插件将自动加载。

## ⚙️ 配置说明

插件加载后，会在 `data/configs` 目录下生成一个名为 `astrbot_plugin_siliconflow.json` 的配置文件。请打开并编辑它。

以下是所有配置项的详细说明：

| 配置项 (Key) | 类型 | 描述 | 默认值 | 示例/备注 |
| :--- | :--- | :--- | :--- | :--- |
| `api_url` | string | SiliconFlow API 的 URL 地址。 | `"https://api.siliconflow.cn"` | 通常无需修改。 |
| `api_keys` | list | **【必需】** 您的 SiliconFlow API 密钥列表。可以填写多个，插件会自动轮换使用。 | `[]` | `["sk-key1", "sk-key2"]` |
| `default_model` | string | 默认使用的视频生成模型。 | `"stabilityai/..."` | 通常无需修改。 |
| `use_proxy` | bool | 是否启用网络代理。 | `false` | 如果您的服务器无法直连 API，请设为 `true`。 |
| `proxy_url` | string | 网络代理地址，格式为 `http://user:pass@host:port`。 | `""` | `use_proxy` 为 `true` 时生效。 |
| `enable_user_limit`| bool | 是否启用【用户】个人次数限制。 | `true` | 推荐保持开启，避免滥用。 |
| `enable_group_limit`| bool | 是否启用【群组】共享次数限制。 | `false` | 开启后，群内任何人使用都会消耗群次数。 |
| `polling_interval`| int | 【高级】任务状态轮询间隔（秒）。 | `5` | 通常无需修改。 |
| `polling_timeout` | int | 【高级】任务超时时间（秒）。 | `300` | 通常无需修改。 |
| `user_whitelist` | list | 【权限】用户白名单，列表内的用户才可使用。 | `[]` | `["10001", "12345"]` |
| `user_blacklist` | list | 【权限】用户黑名单，列表内的用户禁止使用。 | `[]` | `["54321"]` |
| `group_whitelist` | list | 【权限】群聊白名单，只有在这些群里插件才生效。| `[]` | `["111111", "222222"]` |

**重要提示**: 权限逻辑为：黑名单最优先。如果设置了白名单，则用户/群组必须在白名单内才可使用。

## 🚀 使用指令

### 普通用户指令

-   **生成视频**: `#生成视频 <提示词> [附带图片]`
    -   **文生视频**: 直接发送 `#生成视频 宇航员在月球上行走`
    -   **图生视频**: 发送一张图片，然后回复该图片并输入 `#生成视频 让图片动起来`
    -   **视频签到**: 次数签到 `#需在配置文件里面打开此功能 `

-   **查询次数**: `#视频查询次数`
    -   查询您个人和所在群聊的剩余使用次数。

### 管理员指令

**注意**: 需要将您的 QQ 号配置在 AstrBot 的全局配置文件 `global_config.json` 的 `admins_id` 列表中。

-   **增加用户次数**: `#视频增加用户次数 <QQ号> <次数>`
    -   示例: `#视频增加用户次数 123456 20` (为 QQ 用户 123456 增加 20 次使用机会)

-   **增加群组次数**: `#视频增加群组次数 <群号> <次数>`
    -   示例: `#视频增加群组次数 111111 100` (为群 111111 增加 100 次共享使用机会)
  
-   **视频添加预设**: `#视频添加预设 触发:内容`
## ❓ 常见问题 (FAQ)

1.  **机器人提示 "未配置任何 API 密钥"**
    > 请检查配置文件 `astrbot_plugin_siliconflow.json`，确保 `api_keys` 字段已正确填写您的密钥。

2.  **机器人只发送了链接，没有发送视频文件**
    > 这是**正常现象**。由于不同平台对机器人发送文件的限制和兼容性问题，直接发送视频文件可能会失败。为了保证您一定能收到结果，当前版本的插件会发送一个视频的 **URL 链接**。现代的聊天客户端（如 QQ）会自动识别这个链接并生成一个可供在线播放的视频预览窗口，体验与直接发送文件类似。

3.  **提示 "次数已用尽"**
    > 这说明您的个人次数或所在群组的共享次数已经用完。请联系机器人管理员为您增加次数。

4.  **机器人没有反应**
    > -   请检查 AstrBot 的后台日志，确认是否有报错信息。
    > -   如果您设置了白名单，请确认您的 QQ 号或所在群号是否在白名单内。
    > -   确认您没有在黑名单内。
5.  **次数为0还能使用**
    > 请检查插件配置里面的，用户次数限制和群组次数限制均打开了。
